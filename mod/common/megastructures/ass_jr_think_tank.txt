@stage_1_research_bonus	= 100
@stage_2_research_bonus	= 200
@stage_3_research_bonus	= 300
@stage_4_research_bonus	= 350
@entity_x				= 0
@entity_y				= -20

# Ruined Science Nexus
think_tank_ruined = {
	entity = "think_tank_destroyed_01_entity"
	portrait = "GFX_megastructure_construction_background"

	place_entity_on_planet_plane = no
	entity_offset = { x = @entity_x y = @entity_y }

	resources = {
		category = megastructures

		# Just keeping the structure stable makes
		# it similar in cost to Phase 0.
		upkeep = {
			energy = 5
		}
	}

	potential = {
		always = no
	}
}

think_tank_jury_rig = {
	entity = "think_tank_jr_entity"
	construction_entity = "thinktank_phase_03_entity"
	portrait = "GFX_megastructure_construction_background"
	place_entity_on_planet_plane = no
	entity_offset = { x = @entity_x y = @entity_y }
	build_time = 800 # 1800

	resources = {
		category = megastructures
		cost = {
			alloys = 1500
		}

		upkeep = {
			energy = 40
		}

		produces = {
			society_research = 50
			engineering_research = 50
			physics_research = 50
		}
	}

	possible = {
		from = {
			has_technology = tech_starbase_3     # requires Starholds (>< Starbase) are unlocked
#			has_technology = tech_physics_lab_2  # requires all Tech 3 Science Labs to be unlocked
#			has_technology = tech_biolab_2
#			has_technology = tech_engineering_lab_2
		}
	}

	upgrade_from = {
		think_tank_ruined
	}

	country_modifier = {
		all_technology_research_speed = 0.05   ## 0.05 for level 1
	}

	on_build_start = {}
	on_build_cancel = {}
	on_build_complete = {
		set_star_flag = think_tank_built
		fromfrom.planet = {
			set_planet_flag = has_megastructure
		}
		from = {
			if = {
				limit = {
					AND = {
						has_relic = r_contingency_core
						has_country_flag = built_think_tank
					}
				}
				set_country_flag = built_think_tank_contingency
			}
			set_country_flag = built_think_tank
		}
	}
}

think_tank_restored = {
	entity = "thinktank_phase_03_entity"
	construction_entity = "thinktank_phase_03_entity"
	portrait = "GFX_megastructure_think_tank_background"
	place_entity_on_planet_plane = no
	entity_offset = { x = @entity_x y = @entity_y }
	build_time = 4800
	resources = {
		category = megastructures
		cost = {
			alloys = 15000
			unity = 3200
		}

		upkeep = {
			energy = 75
		}

		produces = {
			society_research = @stage_3_research_bonus
			engineering_research = @stage_3_research_bonus
			physics_research = @stage_3_research_bonus
		}
	}

	upgrade_from = {
		think_tank_ruined
	}

	possible = {
		from = { has_technology = tech_mega_engineering }
	}

	country_modifier = {
		all_technology_research_speed = 0.15
	}

	on_build_start = {
		fromfrom = {
			set_graphical_culture = root.from
		}
	}

	on_build_complete = {
		# BUGFIX: This is in case we go from ruined to restored.
		if = {
			limit = {
				NOT = {
					has_star_flag = think_tank_built
				}
			}
			set_star_flag = think_tank_built
		}
		fromfrom.planet = {
			if = {
				limit = {
					NOT = {
						has_planet_flag = has_megastructure
					}
				}
				set_planet_flag = has_megastructure
			}
		}
		every_system_ambient_object = {
			limit = {
				OR = {
					is_ambient_object_type = large_debris_object
					is_ambient_object_type = medium_debris_01_object
					is_ambient_object_type = medium_debris_02_object
				}
			}
			destroy_ambient_object = this
		}
		from = {
			# BUGFIX: This is in case we go from ruined to restored.
			if = { # This check needs to be first so we can tell if this is our second dyson sphere.
				limit = {
					AND = {
						has_relic = r_contingency_core
						has_country_flag = built_think_tank
						NOT = {
							has_country_flag = built_think_tank_contingency
						}
					}
				}
				set_country_flag = built_think_tank_contingency
			}
			else = {
				if = {
					limit = {
						NOT = {
							has_country_flag = built_think_tank
						}
					}
					set_country_flag = built_think_tank
				}
			}
			set_country_flag = has_built_or_repaired_megastructure
			country_event = { id = utopia.2013 }
		}
	}
}
