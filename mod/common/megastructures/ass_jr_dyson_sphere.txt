# Ruined Dyson Sphere
dyson_sphere_ruined = {
	entity = "dyson_sphere_destroyed_entity"
	portrait = "GFX_megastructure_construction_background"

	resources = {
		category = megastructures

		# Just keeping the structure stable makes
		# it similar in cost to Phase 0.
		upkeep = {
			energy = 5
		}
	}

	potential = {
		always = no
	}
}

# BUGFIX: Ruined megas are no longer free from contingency limits.

dyson_sphere_jury_rig = {
	entity = "dyson_sphere_destroyed_entity"
	construction_entity = "dyson_sphere_frame_entity"
	portrait = "GFX_megastructure_construction_jr_background"
	build_time = 900
	resources = {
		category = megastructures
		cost = {
			alloys = 2000
		}

		produces = {
			energy = 100
		}
	}
	upgrade_from = {
		dyson_sphere_ruined
	}

	possible = {
		from = { has_technology = tech_starbase_3 }
	}

	on_build_start = {
		fromfrom = {
			set_graphical_culture = root.from
		}
	}
	on_build_cancel = {}

	# This is in case we go from ruined to jury rig and stay there.
	on_build_complete = {
		set_star_flag = dyson_sphere_built
		remove_system_terraforming_candidates = yes
		from = {
			if = {
				limit = {
					AND = {
						has_relic = r_contingency_core
						has_country_flag = built_dyson_sphere
					}
				}
				set_country_flag = built_dyson_sphere_contingency
			}
			set_country_flag = built_dyson_sphere
		}
		fromfrom.planet = {
			if = {
				limit = { has_orbital_station = yes }
				orbital_station = {
					dismantle = yes
				}
			}
		}
	}
}

# Restored Dyson Sphere
dyson_sphere_restored = {
	entity = "dyson_sphere_phase_05_entity"
	construction_entity = "dyson_sphere_part_4_entity"
	portrait = "GFX_megastructure_dyson_sphere_background"
	build_time = 7200
	resources = {
		category = megastructures
		cost = {
			alloys = 20000
			unity = 7500
		}

		produces = {
			energy = 4000
		}
	}
	upgrade_from = {
		dyson_sphere_ruined
		dyson_sphere_jury_rig # CUSTOM
	}

	possible = {
		from = { has_technology = tech_mega_engineering }
	}

	on_build_start = {
		fromfrom = {
			set_graphical_culture = root.from
		}
	}

	on_build_complete = {
		# BUGFIX: This is in case we go from ruined to restored.
		if = {
			limit = {
				NOT = {
					has_star_flag = dyson_sphere_built
				}
				set_star_flag = dyson_sphere_built
			}
		}
		every_system_planet = {
			limit = {
				OR = {
					is_planet_class = pc_molten
					is_planet_class = pc_toxic
				}
			}
			change_pc = pc_frozen
		}
		every_system_planet = {
			limit = {
				is_planet_class = pc_barren
			}
			change_pc = pc_barren_cold
		}
		remove_system_terraforming_candidates = yes
		every_system_ambient_object = {
			limit = {
				OR = {
					is_ambient_object_type = large_debris_object
					is_ambient_object_type = medium_debris_01_object
					is_ambient_object_type = medium_debris_02_object
					is_ambient_object_type = small_debris_object
				}
			}
			destroy_ambient_object = this
		}
		from = {
			# BUGFIX: This is in case we go from ruined to restored.
			if = { # This check needs to be first so we can tell if this is our second dyson sphere.
				limit = {
					AND = {
						has_relic = r_contingency_core
						has_country_flag = built_dyson_sphere
						NOT = {
							has_country_flag = built_dyson_sphere_contingency
						}
					}
				}
				set_country_flag = built_dyson_sphere_contingency
			}
			else = {
				if = {
					limit = {
						NOT = {
							has_country_flag = built_dyson_sphere
						}
					}
					set_country_flag = built_dyson_sphere
				}
			}
			set_country_flag = has_built_or_repaired_megastructure
			country_event = { id = utopia.2011 }
		}
	}
}
